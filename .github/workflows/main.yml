name: Unity WebGL Build & Test

on:
  push:
    branches: [master]
  pull_request:
  workflow_dispatch:

jobs:
  prepare:
    name: ğŸ“ Get Unity Version
    runs-on: ubuntu-latest
    outputs:
      unityVersion: ${{ steps.unity-version.outputs.unityVersion }}

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Read Unity version from ProjectVersion.txt
        id: unity-version
        run: |
          version=$(grep -oP '(?<=m_EditorVersion: ).*' ProjectSettings/ProjectVersion.txt)
          echo "Unity version detected: $version"
          echo "unityVersion=$version" >> $GITHUB_OUTPUT

  test:
    name: ğŸ§ª Run Tests
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Run Unity Test Runner
        uses: game-ci/unity-test-runner@v4
        with:
          unityVersion: ${{ needs.prepare.outputs.unityVersion }}
          testMode: playmode
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

  build:
    name: ğŸŒ Build WebGL
    needs: [prepare, test]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§± Build WebGL
        uses: game-ci/unity-builder@v4
        with:
          targetPlatform: WebGL
          unityVersion: ${{ needs.prepare.outputs.unityVersion }}
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      - name: ğŸ“¦ Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL